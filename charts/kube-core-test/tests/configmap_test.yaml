suite: ConfigMap template tests
templates:
  - templates/alpha.yaml
values:
  - ../ci/minimal-values.yaml
release:
  name: test-release
  namespace: test-ns
chart:
  version: 0.1.0
  appVersion: 1.0.0
tests:
  - it: should not render ConfigMap when disabled
    asserts:
      - not: true
        containsDocument:
          kind: ConfigMap
          apiVersion: v1
          any: true

  - it: should render ConfigMap with data
    set:
      alpha.configmap.enabled: true
      alpha.configmap.data:
        config.yaml: "server:\n  port: 8080"
    asserts:
      - containsDocument:
          kind: ConfigMap
          apiVersion: v1
          any: true
      - isSubset:
          path: data
          content:
            config.yaml: "server:\n  port: 8080"
        documentSelector:
          path: kind
          value: ConfigMap

  - it: should use auto-generated name
    set:
      alpha.configmap.enabled: true
      alpha.configmap.data:
        key: value
    asserts:
      - equal:
          path: metadata.name
          value: test-release-alpha
        documentSelector:
          path: kind
          value: ConfigMap

  - it: should use custom name when set
    set:
      alpha.configmap.enabled: true
      alpha.configmap.name: my-custom-cm
      alpha.configmap.data:
        key: value
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-cm
        documentSelector:
          path: kind
          value: ConfigMap

  - it: should render ConfigMap annotations
    set:
      alpha.configmap.enabled: true
      alpha.configmap.data:
        key: value
      alpha.configmap.annotations:
        custom: "true"
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            custom: "true"
        documentSelector:
          path: kind
          value: ConfigMap

  - it: should render ConfigMap labels
    set:
      alpha.configmap.enabled: true
      alpha.configmap.data:
        key: value
      alpha.configmap.labels:
        custom: "true"
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            custom: "true"
        documentSelector:
          path: kind
          value: ConfigMap

  - it: should fail when enabled but no data or binaryData
    set:
      alpha.configmap.enabled: true
      alpha.configmap.data: {}
      alpha.configmap.binaryData: {}
    asserts:
      - failedTemplate:
          errorMessage: "ConfigMap is enabled but neither data nor binaryData is set"

  - it: should render binaryData
    set:
      alpha.configmap.enabled: true
      alpha.configmap.data: {}
      alpha.configmap.binaryData:
        icon.png: "iVBORw0KGg=="
    asserts:
      - containsDocument:
          kind: ConfigMap
          apiVersion: v1
          any: true
      - isSubset:
          path: binaryData
          content:
            icon.png: "iVBORw0KGg=="
        documentSelector:
          path: kind
          value: ConfigMap

  - it: should include standard labels
    set:
      alpha.configmap.enabled: true
      alpha.configmap.data:
        key: value
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: alpha
            app.kubernetes.io/instance: test-release
            app.kubernetes.io/managed-by: Helm
        documentSelector:
          path: kind
          value: ConfigMap
