suite: Helper template tests
templates:
  - templates/alpha.yaml
values:
  - ../ci/minimal-values.yaml
release:
  name: test-release
  namespace: test-ns
chart:
  version: 0.1.0
  appVersion: 1.0.0
tests:
  - it: should generate correct fullname
    asserts:
      - equal:
          path: metadata.name
          value: test-release-alpha
        documentSelector:
          path: kind
          value: Deployment

  - it: should use fullnameOverride
    set:
      alpha.fullnameOverride: custom-name
    asserts:
      - equal:
          path: metadata.name
          value: custom-name
        documentSelector:
          path: kind
          value: Deployment

  - it: should deduplicate when release name contains chart name
    release:
      name: alpha
    asserts:
      - equal:
          path: metadata.name
          value: alpha
        documentSelector:
          path: kind
          value: Deployment

  - it: should render helm.sh/chart label
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            helm.sh/chart: kube-core-test-0.1.0
        documentSelector:
          path: kind
          value: Deployment

  - it: should render app version label
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/version: "1.0.0"
        documentSelector:
          path: kind
          value: Deployment

  - it: should render managed-by label
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/managed-by: Helm
        documentSelector:
          path: kind
          value: Deployment

  - it: should render consistent selector labels across Deployment and Service
    asserts:
      - isSubset:
          path: spec.selector.matchLabels
          content:
            app.kubernetes.io/name: alpha
            app.kubernetes.io/instance: test-release
        documentSelector:
          path: kind
          value: Deployment
      - isSubset:
          path: spec.selector
          content:
            app.kubernetes.io/name: alpha
            app.kubernetes.io/instance: test-release
        documentSelector:
          path: kind
          value: Service

  - it: should fail when fullnameOverride exceeds 63 characters
    set:
      alpha.fullnameOverride: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
    asserts:
      - failedTemplate:
          errorPattern: exceeds 63 characters

  - it: should omit app version label when appVersion not set
    chart:
      version: 0.1.0
      appVersion: null
    asserts:
      - notExists:
          path: metadata.labels.app\.kubernetes\.io/version
        documentSelector:
          path: kind
          value: Deployment
