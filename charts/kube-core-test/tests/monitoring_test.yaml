suite: Monitoring template tests (ServiceMonitor + PrometheusRule)
templates:
  - templates/alpha.yaml
values:
  - ../ci/minimal-values.yaml
release:
  name: test-release
  namespace: test-ns
chart:
  version: 0.1.0
  appVersion: 1.0.0
tests:
  - it: should not render ServiceMonitor when disabled
    asserts:
      - not: true
        containsDocument:
          kind: ServiceMonitor
          apiVersion: monitoring.coreos.com/v1
          any: true

  - it: should not render PrometheusRule when disabled
    asserts:
      - not: true
        containsDocument:
          kind: PrometheusRule
          apiVersion: monitoring.coreos.com/v1
          any: true

  - it: should render ServiceMonitor with endpoint
    set:
      alpha.serviceMonitor.enabled: true
    asserts:
      - containsDocument:
          kind: ServiceMonitor
          apiVersion: monitoring.coreos.com/v1
          any: true
      - equal:
          path: metadata.name
          value: test-release-alpha
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render ServiceMonitor selector labels
    set:
      alpha.serviceMonitor.enabled: true
    asserts:
      - isSubset:
          path: spec.selector.matchLabels
          content:
            app.kubernetes.io/name: alpha
            app.kubernetes.io/instance: test-release
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render ServiceMonitor endpoint details
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.endpoints:
        - port: metrics
          interval: 30s
          scrapeTimeout: 10s
          path: /metrics
          scheme: http
          honorLabels: false
          honorTimestamps: true
    asserts:
      - equal:
          path: spec.endpoints[0].port
          value: metrics
        documentSelector:
          path: kind
          value: ServiceMonitor
      - equal:
          path: spec.endpoints[0].interval
          value: 30s
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render ServiceMonitor custom labels
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.labels:
        release: prometheus
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            release: prometheus
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render ServiceMonitor with relabelings
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.endpoints:
        - port: http
          relabelings:
            - sourceLabels: [__meta_kubernetes_pod_name]
              targetLabel: pod
    asserts:
      - equal:
          path: spec.endpoints[0].relabelings[0].targetLabel
          value: pod
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render PrometheusRule with alert
    set:
      alpha.prometheusRule.enabled: true
      alpha.prometheusRule.prometheusLabel: "kube-prometheus"
      alpha.prometheusRule.rules:
        - name: alpha-alerts
          groups:
            - name: alpha
              rules:
                - alert: HighErrorRate
                  expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
                  for: 5m
                  labels:
                    severity: warning
                  annotations:
                    summary: High error rate
    asserts:
      - containsDocument:
          kind: PrometheusRule
          apiVersion: monitoring.coreos.com/v1
          any: true
      - equal:
          path: metadata.name
          value: test-release-alpha-alpha-alerts
        documentSelector:
          path: kind
          value: PrometheusRule

  - it: should render PrometheusRule prometheus label
    set:
      alpha.prometheusRule.enabled: true
      alpha.prometheusRule.prometheusLabel: "kube-prometheus"
      alpha.prometheusRule.rules:
        - name: alpha-alerts
          groups:
            - name: alpha
              rules:
                - alert: Test
                  expr: up == 0
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            prometheus: kube-prometheus
            role: alert-rules
        documentSelector:
          path: kind
          value: PrometheusRule

  - it: should render PrometheusRule with recording rule
    set:
      alpha.prometheusRule.enabled: true
      alpha.prometheusRule.rules:
        - name: alpha-recordings
          groups:
            - name: alpha
              rules:
                - record: job:http_requests_total:rate5m
                  expr: rate(http_requests_total[5m])
    asserts:
      - containsDocument:
          kind: PrometheusRule
          apiVersion: monitoring.coreos.com/v1
          any: true

  - it: should render ServiceMonitor annotations
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.annotations:
        custom.io/scrape: "true"
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            custom.io/scrape: "true"
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render ServiceMonitor jobLabel
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.jobLabel: alpha-service
    asserts:
      - equal:
          path: spec.jobLabel
          value: alpha-service
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render ServiceMonitor with metricRelabelings
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.endpoints:
        - port: http
          metricRelabelings:
            - sourceLabels: [__name__]
              regex: "expensive_metric_.*"
              action: drop
    asserts:
      - equal:
          path: spec.endpoints[0].metricRelabelings[0].action
          value: drop
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should fail ServiceMonitor when no endpoints defined
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.endpoints: null
    asserts:
      - failedTemplate:
          errorMessage: "serviceMonitor.endpoints must contain at least one endpoint"

  - it: should render ServiceMonitor with multiple endpoints
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.endpoints:
        - port: http
          interval: 30s
          path: /metrics
        - port: metrics
          interval: 60s
          path: /stats
    asserts:
      - lengthEqual:
          path: spec.endpoints
          count: 2
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render ServiceMonitor with custom selector
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.selector:
        environment: dev
    asserts:
      - isSubset:
          path: spec.selector.matchLabels
          content:
            environment: dev
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render ServiceMonitor with tlsConfig
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.endpoints:
        - port: https
          scheme: https
          tlsConfig:
            insecureSkipVerify: true
    asserts:
      - equal:
          path: spec.endpoints[0].tlsConfig.insecureSkipVerify
          value: true
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should not render PrometheusRule when enabled but no rules
    set:
      alpha.prometheusRule.enabled: true
      alpha.prometheusRule.rules: []
    asserts:
      - not: true
        containsDocument:
          kind: PrometheusRule
          apiVersion: monitoring.coreos.com/v1
          any: true

  - it: should render PrometheusRule with mixed alert and recording rules
    set:
      alpha.prometheusRule.enabled: true
      alpha.prometheusRule.rules:
        - name: mixed-rules
          groups:
            - name: mixed
              rules:
                - alert: HighLatency
                  expr: histogram_quantile(0.99, rate(http_duration_seconds_bucket[5m])) > 1
                  for: 10m
                  labels:
                    severity: warning
                  annotations:
                    summary: High latency
                - record: job:http_requests_total:rate5m
                  expr: rate(http_requests_total[5m])
                  labels:
                    environment: dev
    asserts:
      - equal:
          path: spec.groups[0].rules[0].alert
          value: HighLatency
        documentSelector:
          path: kind
          value: PrometheusRule
      - equal:
          path: spec.groups[0].rules[1].record
          value: "job:http_requests_total:rate5m"
        documentSelector:
          path: kind
          value: PrometheusRule

  - it: should render ServiceMonitor with basicAuth
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.endpoints:
        - port: http
          basicAuth:
            username:
              name: prom-basic-auth
              key: username
            password:
              name: prom-basic-auth
              key: password
    asserts:
      - equal:
          path: spec.endpoints[0].basicAuth.username.name
          value: prom-basic-auth
        documentSelector:
          path: kind
          value: ServiceMonitor
      - equal:
          path: spec.endpoints[0].basicAuth.password.key
          value: password
        documentSelector:
          path: kind
          value: ServiceMonitor

  - it: should render ServiceMonitor with authorization
    set:
      alpha.serviceMonitor.enabled: true
      alpha.serviceMonitor.endpoints:
        - port: http
          authorization:
            type: Bearer
            credentials:
              name: prom-token
              key: token
    asserts:
      - equal:
          path: spec.endpoints[0].authorization.type
          value: Bearer
        documentSelector:
          path: kind
          value: ServiceMonitor
