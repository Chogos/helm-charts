suite: Multi-service name isolation tests
templates:
  - templates/alpha.yaml
  - templates/bravo.yaml
values:
  - ../ci/multi-service-values.yaml
release:
  name: test-release
  namespace: test-ns
chart:
  version: 0.1.0
  appVersion: 1.0.0
tests:
  - it: should render alpha deployment with correct name
    asserts:
      - equal:
          path: metadata.name
          value: test-release-alpha
        documentSelector:
          path: kind
          value: Deployment
        template: templates/alpha.yaml

  - it: should render bravo deployment with correct name
    asserts:
      - equal:
          path: metadata.name
          value: test-release-bravo
        documentSelector:
          path: kind
          value: Deployment
        template: templates/bravo.yaml

  - it: should render alpha service
    asserts:
      - containsDocument:
          kind: Service
          apiVersion: v1
          any: true
        template: templates/alpha.yaml

  - it: should not render bravo service when disabled
    asserts:
      - not: true
        containsDocument:
          kind: Service
          apiVersion: v1
          any: true
        template: templates/bravo.yaml

  - it: should render separate ServiceAccounts
    asserts:
      - equal:
          path: metadata.name
          value: test-release-alpha
        documentSelector:
          path: kind
          value: ServiceAccount
        template: templates/alpha.yaml
      - equal:
          path: metadata.name
          value: test-release-bravo
        documentSelector:
          path: kind
          value: ServiceAccount
        template: templates/bravo.yaml

  - it: alpha and bravo should have different selector labels
    asserts:
      - isSubset:
          path: spec.selector.matchLabels
          content:
            app.kubernetes.io/name: alpha
        documentSelector:
          path: kind
          value: Deployment
        template: templates/alpha.yaml
      - isSubset:
          path: spec.selector.matchLabels
          content:
            app.kubernetes.io/name: bravo
        documentSelector:
          path: kind
          value: Deployment
        template: templates/bravo.yaml

  - it: should use correct images for each service
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "myapp/alpha:1.0.0"
        documentSelector:
          path: kind
          value: Deployment
        template: templates/alpha.yaml
      - equal:
          path: spec.template.spec.containers[0].image
          value: "myapp/bravo:1.0.0"
        documentSelector:
          path: kind
          value: Deployment
        template: templates/bravo.yaml

  - it: should set correct replica counts per service
    asserts:
      - equal:
          path: spec.replicas
          value: 2
        documentSelector:
          path: kind
          value: Deployment
        template: templates/alpha.yaml
      - equal:
          path: spec.replicas
          value: 1
        documentSelector:
          path: kind
          value: Deployment
        template: templates/bravo.yaml
