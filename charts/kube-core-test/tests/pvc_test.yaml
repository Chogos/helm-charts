suite: PersistentVolumeClaim template tests
templates:
  - templates/alpha.yaml
values:
  - ../ci/minimal-values.yaml
release:
  name: test-release
  namespace: test-ns
chart:
  version: 0.1.0
  appVersion: 1.0.0
tests:
  - it: should not render PVC when no persistent volumes defined
    asserts:
      - not: true
        containsDocument:
          kind: PersistentVolumeClaim
          apiVersion: v1
          any: true

  - it: should render PVC with required fields
    set:
      alpha.persistentVolumes:
        - name: data
          mountPath: /data
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "10Gi"
    asserts:
      - containsDocument:
          kind: PersistentVolumeClaim
          apiVersion: v1
          any: true
      - equal:
          path: metadata.name
          value: test-release-alpha-data
        documentSelector:
          path: kind
          value: PersistentVolumeClaim

  - it: should set storage class
    set:
      alpha.persistentVolumes:
        - name: data
          mountPath: /data
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "10Gi"
    asserts:
      - equal:
          path: spec.storageClassName
          value: "gp3"
        documentSelector:
          path: kind
          value: PersistentVolumeClaim

  - it: should set access modes
    set:
      alpha.persistentVolumes:
        - name: data
          mountPath: /data
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "10Gi"
    asserts:
      - contains:
          path: spec.accessModes
          content: ReadWriteOnce
        documentSelector:
          path: kind
          value: PersistentVolumeClaim

  - it: should set storage size
    set:
      alpha.persistentVolumes:
        - name: data
          mountPath: /data
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "10Gi"
    asserts:
      - equal:
          path: spec.resources.requests.storage
          value: "10Gi"
        documentSelector:
          path: kind
          value: PersistentVolumeClaim

  - it: should set volumeMode when specified
    set:
      alpha.persistentVolumes:
        - name: data
          mountPath: /data
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "10Gi"
          volumeMode: Block
    asserts:
      - equal:
          path: spec.volumeMode
          value: Block
        documentSelector:
          path: kind
          value: PersistentVolumeClaim

  - it: should render multiple PVCs
    set:
      alpha.persistentVolumes:
        - name: data
          mountPath: /data
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "10Gi"
        - name: logs
          mountPath: /var/log
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "5Gi"
    asserts:
      - hasDocuments:
          count: 5

  - it: should render PVC with selector
    set:
      alpha.persistentVolumes:
        - name: data
          mountPath: /data
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "10Gi"
          selector:
            matchLabels:
              app: alpha
    asserts:
      - isSubset:
          path: spec.selector.matchLabels
          content:
            app: alpha
        documentSelector:
          path: kind
          value: PersistentVolumeClaim

  - it: should render PVC with volumeName
    set:
      alpha.persistentVolumes:
        - name: data
          mountPath: /data
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "10Gi"
          volumeName: pv-existing-data
    asserts:
      - equal:
          path: spec.volumeName
          value: "pv-existing-data"
        documentSelector:
          path: kind
          value: PersistentVolumeClaim

  - it: should include standard labels
    set:
      alpha.persistentVolumes:
        - name: data
          mountPath: /data
          storageClassName: gp3
          accessModes:
            - ReadWriteOnce
          storage: "10Gi"
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: alpha
            app.kubernetes.io/instance: test-release
        documentSelector:
          path: kind
          value: PersistentVolumeClaim
