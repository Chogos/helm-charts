suite: Service template tests
templates:
  - templates/alpha.yaml
values:
  - ../ci/minimal-values.yaml
release:
  name: test-release
  namespace: test-ns
chart:
  version: 0.1.0
  appVersion: 1.0.0
tests:
  - it: should render a ClusterIP Service
    asserts:
      - containsDocument:
          kind: Service
          apiVersion: v1
          any: true
      - equal:
          path: spec.type
          value: ClusterIP
        documentSelector:
          path: kind
          value: Service

  - it: should set service name matching deployment
    asserts:
      - equal:
          path: metadata.name
          value: test-release-alpha
        documentSelector:
          path: kind
          value: Service

  - it: should render service port mapping
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 80
            targetPort: http
            protocol: TCP
            name: http
        documentSelector:
          path: kind
          value: Service

  - it: should include selector labels matching deployment pods
    asserts:
      - isSubset:
          path: spec.selector
          content:
            app.kubernetes.io/name: alpha
            app.kubernetes.io/instance: test-release
        documentSelector:
          path: kind
          value: Service

  - it: should include standard labels
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: alpha
            app.kubernetes.io/instance: test-release
            app.kubernetes.io/managed-by: Helm
        documentSelector:
          path: kind
          value: Service

  - it: should render annotations
    set:
      alpha.service.annotations:
        service.beta.kubernetes.io/aws-load-balancer-type: nlb
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            service.beta.kubernetes.io/aws-load-balancer-type: nlb
        documentSelector:
          path: kind
          value: Service

  - it: should support NodePort type
    set:
      alpha.service.type: NodePort
    asserts:
      - equal:
          path: spec.type
          value: NodePort
        documentSelector:
          path: kind
          value: Service

  - it: should support LoadBalancer type
    set:
      alpha.service.type: LoadBalancer
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer
        documentSelector:
          path: kind
          value: Service

  - it: should render multiple ports
    set:
      alpha.service.ports:
        - name: http
          port: 80
          targetPort: http
          protocol: TCP
        - name: metrics
          port: 9090
          targetPort: metrics
          protocol: TCP
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 2
        documentSelector:
          path: kind
          value: Service

  - it: should not render when service.enabled is false
    set:
      alpha.service.enabled: false
    asserts:
      - not: true
        containsDocument:
          kind: Service
          apiVersion: v1
          any: true

  - it: should fail when no ports defined
    set:
      alpha.service.ports: null
    asserts:
      - failedTemplate:
          errorMessage: "At least one service port must be defined"
