suite: ServiceAccount template tests
templates:
  - templates/alpha.yaml
values:
  - ../ci/minimal-values.yaml
release:
  name: test-release
  namespace: test-ns
chart:
  version: 0.1.0
  appVersion: 1.0.0
tests:
  - it: should create a ServiceAccount by default
    asserts:
      - containsDocument:
          kind: ServiceAccount
          apiVersion: v1
          any: true

  - it: should set auto-generated name
    asserts:
      - equal:
          path: metadata.name
          value: test-release-alpha
        documentSelector:
          path: kind
          value: ServiceAccount

  - it: should use custom name when specified
    set:
      alpha.serviceAccount.name: custom-sa
    asserts:
      - equal:
          path: metadata.name
          value: custom-sa
        documentSelector:
          path: kind
          value: ServiceAccount

  - it: should default automountServiceAccountToken to false
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: false
        documentSelector:
          path: kind
          value: ServiceAccount

  - it: should set automount when true
    set:
      alpha.serviceAccount.automount: true
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true
        documentSelector:
          path: kind
          value: ServiceAccount

  - it: should render annotations
    set:
      alpha.serviceAccount.annotations:
        eks.amazonaws.com/role-arn: "arn:aws:iam::role/my-role"
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            eks.amazonaws.com/role-arn: "arn:aws:iam::role/my-role"
        documentSelector:
          path: kind
          value: ServiceAccount

  - it: should include standard labels
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: alpha
            app.kubernetes.io/instance: test-release
        documentSelector:
          path: kind
          value: ServiceAccount

  - it: should not set namespace explicitly (Helm release handles it)
    asserts:
      - notExists:
          path: metadata.namespace
        documentSelector:
          path: kind
          value: ServiceAccount

  - it: should not render annotations key when empty
    asserts:
      - notExists:
          path: metadata.annotations
        documentSelector:
          path: kind
          value: ServiceAccount

  - it: should render multiple annotations
    set:
      alpha.serviceAccount.annotations:
        eks.amazonaws.com/role-arn: "arn:aws:iam::role/my-role"
        iam.gke.io/gcp-service-account: "sa@project.iam.gserviceaccount.com"
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            eks.amazonaws.com/role-arn: "arn:aws:iam::role/my-role"
            iam.gke.io/gcp-service-account: "sa@project.iam.gserviceaccount.com"
        documentSelector:
          path: kind
          value: ServiceAccount

  - it: should not create when create is false
    set:
      alpha.serviceAccount.create: false
    asserts:
      - not: true
        containsDocument:
          kind: ServiceAccount
          apiVersion: v1
          any: true

  - it: should use custom SA name in Deployment when set
    set:
      alpha.serviceAccount.name: custom-sa
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: custom-sa
        documentSelector:
          path: kind
          value: Deployment

  - it: should reference external SA when create is false with name
    set:
      alpha.serviceAccount.create: false
      alpha.serviceAccount.name: external-sa
    asserts:
      - not: true
        containsDocument:
          kind: ServiceAccount
          apiVersion: v1
          any: true
      - equal:
          path: spec.template.spec.serviceAccountName
          value: external-sa
        documentSelector:
          path: kind
          value: Deployment

  - it: should fall back to "default" SA when create is false and no name
    set:
      alpha.serviceAccount.create: false
      alpha.serviceAccount.name: ""
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: default
        documentSelector:
          path: kind
          value: Deployment

  - it: should match snapshot for minimal SA
    asserts:
      - matchSnapshot:
          path: metadata
        documentSelector:
          path: kind
          value: ServiceAccount
